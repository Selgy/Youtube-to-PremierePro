#!/bin/bash

# Function to log messages
log() {
    local message="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') $message"
}

# Function to download and unzip FFmpeg
download_and_unzip_ffmpeg() {
    local url="$1"
    local output_dir="$2"
    local zip_path="$output_dir/ffmpeg.zip"
    local retry_count=5

    for ((i=1; i<=retry_count; i++)); do
        log "Downloading FFmpeg (attempt $i)..."
        curl -L "$url" --output "$zip_path" && log "FFmpeg download successful." || { log "Failed to download FFmpeg"; continue; }

        log "Unzipping FFmpeg..."
        unzip -o "$zip_path" -d "$output_dir" && { log "FFmpeg unzip successful."; rm "$zip_path"; return 0; } || log "Failed to unzip FFmpeg"

        log "Retrying download and unzip..."
    done

    return 1
}

log "Starting the post-install script."

# Define directories and paths
FFMPEG_BIN_DIR="/Library/Application Support/Adobe/CEP/extensions/com.selgy.youtubetopremiere/exec/_internal/ffmpeg/bin"
YT_DLP_DIR="/Library/Application Support/Adobe/CEP/extensions/com.selgy.youtubetopremiere/exec/_internal"
FFMPEG_URL="https://evermeet.cx/pub/ffmpeg/snapshots/ffmpeg-115189-g0664cbd732.zip"

log "Creating necessary directories..."
mkdir -p "$FFMPEG_BIN_DIR" && log "FFmpeg bin directory created."
mkdir -p "$YT_DLP_DIR" && log "yt-dlp directory created."

log "Downloading and unzipping FFmpeg..."
if download_and_unzip_ffmpeg "$FFMPEG_URL" "$FFMPEG_BIN_DIR"; then
    log "FFmpeg setup completed successfully."
else
    log "Failed to set up FFmpeg after multiple attempts."
    exit 1
fi

# Remove quarantine attribute from FFmpeg to avoid "cannot be opened" error
if xattr -d com.apple.quarantine "$FFMPEG_BIN_DIR/ffmpeg"; then
    log "Removed quarantine attribute from FFmpeg."
else
    log "No quarantine attribute found on FFmpeg."
fi

# Set ownership to the logged-in user, and set execute permissions
loggedInUser=$( scutil <<< "show State:/Users/ConsoleUser" | awk '/Name :/ && ! /loginwindow/ { print $3 }' )
log "Current user: $loggedInUser"
chown "$loggedInUser" "$FFMPEG_BIN_DIR/ffmpeg" "$YT_DLP_DIR/yt-dlp"
chmod +x "$FFMPEG_BIN_DIR/ffmpeg" "$YT_DLP_DIR/yt-dlp"
log "Set ownership and permissions for FFmpeg and yt-dlp."

log "Cleanup started..."
# Force delete the directories
sudo rm -rf "/Applications/YoutubetoPremiere" && log "Deleted /Applications/YoutubetoPremiere directory." || log "Failed to delete /Applications/YoutubetoPremiere"
sudo rm -rf "/Applications/com.selgy.youtubetopremiere" && log "Deleted /Applications/com.selgy.youtubetopremiere directory." || log "Failed to delete /Applications/com.selgy.youtubetopremiere"

log "Cleanup completed."

# Open the web page in the default browser
log "Opening the web page in the default browser..."
open "https://chromewebstore.google.com/u/3/detail/youtube-to-premiere-pro-v/fnhpeiohcfobchjffmgfdeobphhmaibb?hl=fr"
log "Post-install script completed."
